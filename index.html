<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
h2 { margin-bottom:20px; }

.aircraft-showcase {
  display:flex;
  justify-content:center;
  gap:16px;
  margin-bottom:20px;
}
.aircraft-card {
  background:#fff;
  padding:14px 20px;
  border-radius:14px;
  cursor:pointer;
  border:2px solid transparent;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.aircraft-card.active {
  border-color:#1e88e5;
  background:#e3f2fd;
}

.block {
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:20px;
}
th,td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th { background:#eee; }

.buy {
  background:#1e88e5;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}

#map {
  height:420px;
  margin-top:30px;
  border-radius:10px;
}
</style>
</head>

<body>

<h2>‚úàÔ∏è VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</h2>

<div class="aircraft-showcase">
  <div class="aircraft-card" data-type="AN-24">‚úàÔ∏è AN-24</div>
  <div class="aircraft-card" data-type="DHC-6">üõ© DHC-6</div>
  <div class="aircraft-card" data-type="MI">üöÅ –ú–∏-8</div>
  <div class="aircraft-card active" data-type="">üåç –í—Å—è —Å–µ—Ç—å</div>
</div>

<h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h3>
<div class="block">
  <select id="from"><option value="">–û—Ç–∫—É–¥–∞</option></select>
  <select id="to"><option value="">–ö—É–¥–∞</option></select>
  <input type="date" id="dateFrom">
  <input type="date" id="dateTo">
</div>

<h3>–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ: –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h3>
<div class="block">
  <button onclick="setSort('date')">üìÖ –ü–æ –¥–∞—Ç–µ</button>
  <button onclick="setSort('price')">üí∞ –ü–æ —Ü–µ–Ω–µ</button>
</div>

<table id="table" style="display:none">
<thead>
<tr>
  <th>–î–∞—Ç–∞</th><th>–û—Ç–∫—É–¥–∞</th><th>–ö—É–¥–∞</th><th>–†–µ–π—Å</th>
  <th>–í—ã–ª–µ—Ç</th><th>–ü—Ä–∏–ª—ë—Ç</th><th>–°–∞–º–æ–ª—ë—Ç</th><th></th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/jekajekovich/vintagair/main/chukotavia_api_results.csv";

let flights = [];
let activeAircraft = "";
let sortMode = "date";

const AIRPORTS = {
  DYR:[64.734,177.741],
  PWE:[69.783,170.597],
  PVS:[64.378,-173.242],
  KPW:[67.845,166.139],
  KVM:[62.591,174.520],
  "–ë–ù–ì":[63.049,179.316],
  "–í–ì–ò":[64.405,176.002],
  "–≠–ì–¢":[66.320,179.122],
  "–ó–õ–ê":[64.817,179.967]
};

const COLORS = {
  "AN-24":"#d32f2f",
  "DHC-6":"#1976d2",
  "MI":"#388e3c"
};

function normalizeAircraft(a){
  a = a.toUpperCase();
  if(a.includes("AN-24")) return "AN-24";
  if(a.includes("DHC-6")) return "DHC-6";
  if(a.includes("MI")) return "MI";
  return "";
}

Papa.parse(CSV_URL,{
  download:true,
  header:true,
  complete:(res)=>{
    flights = res.data.map(f=>{
      f.aircraftType = normalizeAircraft(f.aircraft);
      f.dateISO = f.date.split(".").reverse().join("-");
      f.priceNum = Number(f.price);
      return f;
    });
    initSelectors();
    initMap();
    render();
  }
});

function getFiltered(){
  return flights.filter(f=>
    (!from.value || f.origin===from.value) &&
    (!to.value || f.destination===to.value) &&
    (!activeAircraft || f.aircraftType===activeAircraft) &&
    (!dateFrom.value || f.dateISO>=dateFrom.value) &&
    (!dateTo.value || f.dateISO<=dateTo.value)
  );
}

function render(){
  let res = getFiltered();
  res.sort((a,b)=> sortMode==="price"
    ? a.priceNum-b.priceNum
    : a.dateISO.localeCompare(b.dateISO));

  rows.innerHTML="";
  table.style.display = res.length?"table":"none";

  res.forEach(f=>{
    rows.innerHTML+=`
      <tr>
        <td>${f.date}</td>
        <td>${f.origin}</td>
        <td>${f.destination}</td>
        <td>${f.flight_number}</td>
        <td>${f.departure}</td>
        <td>${f.arrival}</td>
        <td>${f.aircraft}</td>
        <td>
          <a href="https://booking.chukotavia.com/websky/" target="_blank">
            <button class="buy">–æ—Ç ${f.priceNum.toLocaleString()} ‚ÇΩ</button>
          </a>
        </td>
      </tr>`;
  });

  drawRoutes(res);
}

function initSelectors(){
  fill(from, flights.map(f=>f.origin), "–û—Ç–∫—É–¥–∞");
  fill(to, flights.map(f=>f.destination), "–ö—É–¥–∞");
}
function fill(sel,arr,label){
  sel.innerHTML=`<option value="">${label}</option>`;
  [...new Set(arr)].forEach(v=>sel.add(new Option(v,v)));
}

[from,to,dateFrom,dateTo].forEach(e=>e.onchange=render);

function setSort(m){ sortMode=m; render(); }

document.querySelectorAll(".aircraft-card").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".aircraft-card").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    activeAircraft=c.dataset.type;
    render();
  };
});

/* ===== MAP ===== */
let map, layer;
function initMap(){
  map=L.map("map").setView([65,170],4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  layer=L.layerGroup().addTo(map);
}
function drawRoutes(list){
  layer.clearLayers();
  list.forEach(f=>{
    if(!AIRPORTS[f.origin]||!AIRPORTS[f.destination]) return;
    L.polyline([AIRPORTS[f.origin],AIRPORTS[f.destination]],{
      color:COLORS[f.aircraftType],
      weight:2
    }).addTo(layer);
  });
}

const from=document.getElementById("from");
const to=document.getElementById("to");
const dateFrom=document.getElementById("dateFrom");
const dateTo=document.getElementById("dateTo");
const rows=document.getElementById("rows");
const table=document.getElementById("table");
</script>

</body>
</html>
