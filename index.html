<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir — рейсы ЧукотАВИА</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.geodesic/Leaflet.Geodesic.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
h2 { margin-bottom: 10px; }

.controls select, .controls button {
  padding: 6px;
  margin-right: 6px;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 12px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

th { background: #eee; }

.buy {
  background: #1e88e5;
  color: white;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
}

#map {
  height: 420px;
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>✈️ VintageAir — рейсы ЧукотАВИА</h2>

<div class="controls">
  <select id="from"></select>
  <select id="to"></select>
  <select id="air"></select>
  <button onclick="resetAll()">Сброс</button>
</div>

<table>
<thead>
<tr>
  <th>Дата</th>
  <th>Откуда</th>
  <th>Куда</th>
  <th>Рейс</th>
  <th>Вылет</th>
  <th>Прилёт</th>
  <th>Самолёт</th>
  <th>Покупка</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<script>
let flights = [];

/* ===== COORDS ===== */
const coords = {
  DYR:[64.73,177.52],
  PVS:[64.38,-173.23],
  KPW:[67.83,166.13],
  ВГИ:[67.55,175.85],
  БНГ:[66.32,174.12],
  KVM:[67.05,179.25],
  ЭТТ:[65.74,176.69]
};

/* ===== MAP ===== */
const map = L.map('map').setView([64,180],3);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let geoLayer = L.geodesic([], {steps:40}).addTo(map);

/* ===== CSV LOAD ===== */
fetch('chukotavia_api_results.csv')
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split('\n');
    const headers = lines.shift().split(',');

    flights = lines.map(l => {
      const v = l.split(',');
      let o = {};
      headers.forEach((h,i)=>o[h]=v[i]);
      return o;
    });

    initFilters();
    render();
  });

/* ===== FILTERS ===== */
function initFilters(){
  fillSelect('from', flights.map(f=>f.origin));
  fillSelect('to', flights.map(f=>f.destination));
  fillSelect('air', flights.map(f=>f.aircraft));

  document.getElementById('from').onchange = render;
  document.getElementById('to').onchange = render;
  document.getElementById('air').onchange = render;
}

function fillSelect(id, arr){
  const sel = document.getElementById(id);
  sel.innerHTML = `<option value="">Все</option>`;
  [...new Set(arr)].forEach(v=>sel.add(new Option(v,v)));
}

/* ===== RENDER ===== */
function render(){
  const f = document.getElementById('from').value;
  const t = document.getElementById('to').value;
  const a = document.getElementById('air').value;

  const data = flights.filter(x =>
    (!f || x.origin===f) &&
    (!t || x.destination===t) &&
    (!a || x.aircraft===a)
  );

  document.getElementById('rows').innerHTML='';
  geoLayer.setLatLngs([]);

  data.forEach(x=>{
    document.getElementById('rows').innerHTML += `
      <tr>
        <td>${x.date}</td>
        <td>${x.origin}</td>
        <td>${x.destination}</td>
        <td>${x.flight_number}</td>
        <td>${x.departure}</td>
        <td>${x.arrival}</td>
        <td>${x.aircraft}</td>
        <td>
          <a href="https://booking.chukotavia.com/websky/" target="_blank">
            <button class="buy">от ${Number(x.price).toLocaleString()} ₽</button>
          </a>
        </td>
      </tr>
    `;

    if(coords[x.origin] && coords[x.destination]){
      geoLayer.addLatLngs([[coords[x.origin],coords[x.destination]]]);
    }
  });
}

function resetAll(){
  document.getElementById('from').value='';
  document.getElementById('to').value='';
  document.getElementById('air').value='';
  render();
}
</script>

</body>
</html>
