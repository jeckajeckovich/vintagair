<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir — рейсы ЧукотАВИА</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.geodesic/Leaflet.Geodesic.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
h2 { margin-bottom: 10px; }

.controls select, .controls input, .controls button {
  padding: 6px;
  margin-right: 6px;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 12px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

th {
  background: #eee;
  cursor: pointer;
}

.buy {
  background: #1e88e5;
  color: white;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
}

#map {
  height: 420px;
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>✈️ VintageAir — рейсы ЧукотАВИА</h2>

<div class="controls">
  <select id="from"></select>
  <select id="to"></select>
  <select id="aircraft"></select>

  <input type="date" id="dateFrom">
  <input type="date" id="dateTo">

  <button onclick="resetAll()">Сброс</button>
</div>

<table>
<thead>
<tr>
  <th onclick="sortBy('date')">Дата</th>
  <th>Откуда</th>
  <th>Куда</th>
  <th>Рейс</th>
  <th onclick="sortBy('departure')">Вылет</th>
  <th>Прилёт</th>
  <th>Самолёт</th>
  <th onclick="sortBy('price')">Покупка</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<script>
/* ================= CSV ================= */
const RAW_CSV = `
date,origin,destination,flight_number,departure,arrival,aircraft,price,available
27.01.2026,DYR,БНГ,15,10:00,11:20,ANTONOV AN-24,19000,9
22.01.2026,DYR,ВГИ,49,09:30,11:30,DHC-6,7000,2
29.01.2026,DYR,KPW,25,10:00,12:20,ANTONOV AN-24,17000,9
20.01.2026,DYR,PVS,113,10:00,12:00,ANTONOV AN-24,15000,2
10.02.2026,DYR,KVM,7,09:30,11:35,MI-8,7000,7
`;

/* ================= DATA ================= */
const lines = RAW_CSV.trim().split("\n");
const headers = lines.shift().split(",");

let flights = lines.map(l => {
  const v = l.split(",");
  let o = {};
  headers.forEach((h,i)=>o[h]=v[i]);
  o.price = Number(o.price);
  return o;
});

/* ================= FILTERS ================= */
const fromSel = document.getElementById("from");
const toSel = document.getElementById("to");
const acSel = document.getElementById("aircraft");

function fillSelect(sel, values){
  sel.innerHTML = `<option value="">Все</option>`;
  [...new Set(values)].forEach(v=>{
    sel.add(new Option(v,v));
  });
}

fillSelect(fromSel, flights.map(f=>f.origin));
fillSelect(toSel, flights.map(f=>f.destination));
fillSelect(acSel, flights.map(f=>f.aircraft));

fromSel.onchange = render;
toSel.onchange = render;
acSel.onchange = render;
dateFrom.onchange = render;
dateTo.onchange = render;

/* ================= SORT ================= */
let sortKey = null;
let asc = true;

function sortBy(k){
  asc = sortKey === k ? !asc : true;
  sortKey = k;
  render();
}

/* ================= MAP ================= */
const map = L.map('map').setView([64, 175], 3);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let geoLayer = null;

const coords = {
  DYR:[64.73,177.52],
  PVS:[64.38,-173.23],
  KPW:[67.83,166.13],
  ВГИ:[67.55,175.85],
  БНГ:[66.32,174.12],
  KVM:[67.05,179.25]
};

function drawMap(data){
  if(geoLayer) map.removeLayer(geoLayer);
  geoLayer = L.geodesic(
    data.map(f=>[coords[f.origin], coords[f.destination]]),
    { color:'red', steps:40 }
  ).addTo(map);
}

/* ================= RENDER ================= */
function render(){
  let data = flights.filter(f =>
    (!fromSel.value || f.origin===fromSel.value) &&
    (!toSel.value || f.destination===toSel.value) &&
    (!acSel.value || f.aircraft===acSel.value)
  );

  if(sortKey){
    data.sort((a,b)=>{
      if(sortKey==="price") return asc ? a.price-b.price : b.price-a.price;
      return asc ? a[sortKey].localeCompare(b[sortKey]) : b[sortKey].localeCompare(a[sortKey]);
    });
  }

  const tbody = document.getElementById("rows");
  tbody.innerHTML="";

  data.forEach(f=>{
    const link = `https://booking.chukotavia.com/websky/?from=${f.origin}&to=${f.destination}&date=${f.date}`;
    tbody.innerHTML += `
    <tr>
      <td>${f.date}</td>
      <td>${f.origin}</td>
      <td>${f.destination}</td>
      <td>${f.flight_number}</td>
      <td>${f.departure}</td>
      <td>${f.arrival}</td>
      <td>${f.aircraft}</td>
      <td><a href="${link}" target="_blank"><button class="buy">от ${f.price.toLocaleString()} ₽</button></a></td>
    </tr>`;
  });

  drawMap(data);
}

function resetAll(){
  fromSel.value="";
  toSel.value="";
  acSel.value="";
  dateFrom.value="";
  dateTo.value="";
  sortKey=null;
  render();
}

render();
</script>
</body>
</html>
