<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.geodesic/Leaflet.Geodesic.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding:20px;
  background:#f4f6f8;
}

header {
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:20px;
}

header img { height:48px; }

/* ===== –í–ò–¢–†–ò–ù–ê ===== */
.aircraft-showcase {
  display:flex;
  gap:16px;
  margin-bottom:20px;
  overflow-x:auto;
}

.aircraft-card {
  min-width:160px;
  background:#fff;
  border-radius:14px;
  padding:16px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border:2px solid transparent;
  transition:.2s;
}

.aircraft-card:hover {
  transform:translateY(-4px);
}

.aircraft-card.active {
  border-color:#1e88e5;
  background:#e3f2fd;
}

.aircraft-icon {
  font-size:32px;
  margin-bottom:8px;
}

.filters {
  background:#fff;
  padding:15px;
  border-radius:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

select,input,button {
  padding:7px;
  font-size:14px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:20px;
}

th,td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}

th { background:#eee }

.buy {
  background:#1e88e5;
  color:#fff;
  border:none;
  padding:6px 0;
  border-radius:4px;
  min-width:110px;
}

#map {
  height:420px;
  margin-top:30px;
  border-radius:10px;
}

.legend {
  background:#fff;
  padding:8px 12px;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  line-height:1.6;
}

.legend span {
  display:inline-block;
  width:14px;
  height:3px;
  margin-right:6px;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="">
  <h2>‚úàÔ∏è VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</h2>
</header>

<!-- ===== –í–ò–¢–†–ò–ù–ê –°–ê–ú–û–õ–Å–¢–û–í ===== -->
<div class="aircraft-showcase">
  <div class="aircraft-card" data-type="AN-24">
    <div class="aircraft-icon">‚úàÔ∏è</div>
    AN-24
  </div>
  <div class="aircraft-card" data-type="DHC-6">
    <div class="aircraft-icon">üõ©</div>
    DHC-6
  </div>
  <div class="aircraft-card" data-type="MI">
    <div class="aircraft-icon">üöÅ</div>
    –ú–∏-8
  </div>
  <div class="aircraft-card active" data-type="">
    <div class="aircraft-icon">üåç</div>
    –í—Å—è —Å–µ—Ç—å
  </div>
</div>

<!-- ===== –§–ò–õ–¨–¢–†–´ ===== -->
<div class="filters">
  <select id="from"><option value="">–û—Ç–∫—É–¥–∞</option></select>
  <select id="to"><option value="">–ö—É–¥–∞</option></select>
  <select id="aircraft"><option value="">–¢–∏–ø –í–°</option></select>
  <input type="date" id="dateFrom">
  <input type="date" id="dateTo">
  <button onclick="resetFilters()">–°–±—Ä–æ—Å</button>
</div>

<!-- ===== –¢–ê–ë–õ–ò–¶–ê (–ù–ï –ú–ï–ù–Ø–õ) ===== -->
<table id="table" style="display:none">
<thead>
<tr>
  <th>–î–∞—Ç–∞</th>
  <th>–û—Ç–∫—É–¥–∞</th>
  <th>–ö—É–¥–∞</th>
  <th>–†–µ–π—Å</th>
  <th>–í—ã–ª–µ—Ç</th>
  <th>–ü—Ä–∏–ª—ë—Ç</th>
  <th>–°–∞–º–æ–ª—ë—Ç</th>
  <th></th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<script>
let flights=[];

/* ===== –ê–≠–†–û–ü–û–†–¢–´ ===== */
const AIRPORTS={
  DYR:[64.734,177.741],
  PVS:[64.378,-173.242],
  KPW:[67.845,166.139],
  PWE:[69.783,170.597],
  KVM:[62.591,174.520],
  –≠–ì–¢:[66.320,179.122],
  –ó–õ–ê:[64.817,179.967]
};

/* ===== –í–° ===== */
function normalizeAircraft(a){
  a=a.toUpperCase();
  if(a.includes("AN-24")) return "AN-24";
  if(a.includes("DHC-6")) return "DHC-6";
  if(a.includes("MI")) return "MI";
  return "OTHER";
}

const COLORS={
  "AN-24":"#d32f2f",
  "DHC-6":"#1976d2",
  "MI":"#388e3c",
  "OTHER":"#555"
};

/* ===== –ó–ê–ì–†–£–ó–ö–ê CSV ===== */
fetch("chukotavia_api_results.csv")
.then(r=>r.text())
.then(csv=>{
  const lines=csv.trim().split("\n");
  const h=lines.shift().split(",");
  flights=lines.map(l=>{
    const v=l.split(",");
    let o={};
    h.forEach((k,i)=>o[k]=v[i]);
    o.aircraftType=normalizeAircraft(o.aircraft);
    return o;
  });
  initMap();
  updateFilters();
  render();
});

/* ===== –§–ò–õ–¨–¢–†–´ ===== */
function norm(d){
  const p=d.split(".");
  return `${p[2]}-${p[1]}-${p[0]}`;
}

function filtered(){
  return flights.filter(f=>
    (!from.value||f.origin===from.value)&&
    (!to.value||f.destination===to.value)&&
    (!aircraft.value||f.aircraftType===aircraft.value)&&
    (!dateFrom.value||norm(f.date)>=dateFrom.value)&&
    (!dateTo.value||norm(f.date)<=dateTo.value)
  );
}

function updateFilters(){
  fill(from,filtered().map(f=>f.origin),"–û—Ç–∫—É–¥–∞");
  fill(to,filtered().map(f=>f.destination),"–ö—É–¥–∞");
  fill(aircraft,filtered().map(f=>f.aircraftType),"–¢–∏–ø –í–°");
}

function fill(sel,arr,label){
  const cur=sel.value;
  sel.innerHTML=`<option value="">${label}</option>`;
  [...new Set(arr)].sort().forEach(v=>sel.add(new Option(v,v)));
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function resetFilters(){
  from.value=to.value=aircraft.value=dateFrom.value=dateTo.value="";
  document.querySelectorAll(".aircraft-card").forEach(c=>c.classList.remove("active"));
  document.querySelector('[data-type=""]').classList.add("active");
  updateFilters(); render();
}

/* ===== –¢–ê–ë–õ–ò–¶–ê ===== */
function render(){
  const res=filtered().sort((a,b)=>norm(a.date).localeCompare(norm(b.date)));
  rows.innerHTML="";
  table.style.display=res.length?"table":"none";

  res.forEach(f=>{
    rows.innerHTML+=`
    <tr>
      <td>${f.date}</td>
      <td>${f.origin}</td>
      <td>${f.destination}</td>
      <td>${f.flight_number}</td>
      <td>${f.departure}</td>
      <td>${f.arrival}</td>
      <td>${f.aircraft}</td>
      <td><button class="buy">–æ—Ç ${Number(f.price).toLocaleString()} ‚ÇΩ</button></td>
    </tr>`;
  });
  drawRoutes(res);
}

/* ===== –ö–ê–†–¢–ê –° –î–£–ì–ê–ú–ò ===== */
let map,geo;

function initMap(){
  map=L.map("map",{worldCopyJump:false}).setView([65,170],4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  geo=L.geodesic([], {steps:64}).addTo(map);

  const legend=L.control({position:"bottomright"});
  legend.onAdd=()=>{
    const d=document.createElement("div");
    d.className="legend";
    d.innerHTML=`
      <div><span style="background:${COLORS["AN-24"]}"></span> AN-24</div>
      <div><span style="background:${COLORS["DHC-6"]}"></span> DHC-6</div>
      <div><span style="background:${COLORS["MI"]}"></span> –ú–∏-8</div>`;
    return d;
  };
  legend.addTo(map);
}

function drawRoutes(list){
  geo.setLatLngs([]);
  list.forEach(f=>{
    if(!AIRPORTS[f.origin]||!AIRPORTS[f.destination]) return;

    let [lat1,lng1]=AIRPORTS[f.origin];
    let [lat2,lng2]=AIRPORTS[f.destination];

    if(Math.abs(lng1-lng2)>180){
      if(lng1>lng2) lng1-=360;
      else lng2-=360;
    }

    geo.addLatLngs([{
      latlngs:[[lat1,lng1],[lat2,lng2]],
      options:{color:COLORS[f.aircraftType],weight:2,opacity:.85}
    }]);
  });
}

/* ===== –í–ò–¢–†–ò–ù–ê ===== */
document.querySelectorAll(".aircraft-card").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".aircraft-card").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    aircraft.value=c.dataset.type;
    updateFilters(); render();
  };
});

/* ===== DOM ===== */
const from=document.getElementById("from");
const to=document.getElementById("to");
const aircraft=document.getElementById("aircraft");
const dateFrom=document.getElementById("dateFrom");
const dateTo=document.getElementById("dateTo");
const rows=document.getElementById("rows");
const table=document.getElementById("table");
</script>

</body>
</html>
