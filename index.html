<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
header { display:flex; align-items:center; gap:15px; margin-bottom:20px; }

/* ===== –í–ò–¢–†–ò–ù–ê ===== */
.aircraft-showcase {
  display:flex;
  gap:16px;
  margin-bottom:20px;
  justify-content:center;
}
.aircraft-card {
  min-width:150px;
  background:#fff;
  border-radius:14px;
  padding:16px;
  text-align:center;
  cursor:pointer;
  border:2px solid transparent;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition:.2s;
}
.aircraft-card.active {
  border-color:#1e88e5;
  background:#e3f2fd;
}

.filters, .sortbar {
  background:#fff;
  padding:12px;
  border-radius:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  margin-bottom:12px;
}

table { width:100%; border-collapse:collapse; background:#fff; margin-top:20px; }
th,td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }

.buy {
  background:#1e88e5;
  color:#fff;
  border:none;
  min-width:110px;
  padding:6px 0;
  border-radius:4px;
  cursor:pointer;
}

#map { height:420px; margin-top:30px; border-radius:10px; }
</style>
</head>

<body>

<header>
  <h2>‚úàÔ∏è VintageAir ‚Äî —Ä–µ–π—Å—ã –ß—É–∫–æ—Ç–ê–í–ò–ê</h2>
</header>

<!-- ===== –í–ò–¢–†–ò–ù–ê ===== -->
<div class="aircraft-showcase">
  <div class="aircraft-card" data-type="AN-24">‚úàÔ∏è AN-24</div>
  <div class="aircraft-card" data-type="DHC-6">üõ© DHC-6</div>
  <div class="aircraft-card" data-type="MI">üöÅ –ú–∏-8</div>
  <div class="aircraft-card active" data-type="">üåç –í—Å—è —Å–µ—Ç—å</div>
</div>

<h4>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h4>

<!-- ===== –§–ò–õ–¨–¢–†–´ ===== -->
<div class="filters">
  <select id="from"><option value="">–û—Ç–∫—É–¥–∞</option></select>
  <select id="to"><option value="">–ö—É–¥–∞</option></select>
  <input type="date" id="dateFrom">
  <input type="date" id="dateTo">
  <button onclick="resetAll()">–°–±—Ä–æ—Å</button>
</div>

<h4>–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ: –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h4>

<!-- ===== –°–û–†–¢–ò–†–û–í–ö–ê ===== -->
<div class="sortbar">
  <button onclick="setSort('date')">üìÖ –ü–æ –¥–∞—Ç–µ</button>
  <button onclick="setSort('price')">üí∞ –ü–æ —Ü–µ–Ω–µ</button>
</div>

<!-- ===== –¢–ê–ë–õ–ò–¶–ê ===== -->
<table id="table" style="display:none">
<thead>
<tr>
  <th>–î–∞—Ç–∞</th><th>–û—Ç–∫—É–¥–∞</th><th>–ö—É–¥–∞</th><th>–†–µ–π—Å</th>
  <th>–í—ã–ª–µ—Ç</th><th>–ü—Ä–∏–ª—ë—Ç</th><th>–°–∞–º–æ–ª—ë—Ç</th><th></th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<script>
let flights=[];
let activeAircraftType="";
let sortMode="date";

const AIRPORTS={
  DYR:[64.734,177.741],
  PVS:[64.378,-173.242],
  PWE:[69.783,170.597],
  KPW:[67.845,166.139],
  KVM:[62.591,174.520],
  –≠–ì–¢:[66.320,179.122]
};

const COLORS={
  "AN-24":"#d32f2f",
  "DHC-6":"#1976d2",
  "MI":"#388e3c"
};

function normalizeAircraft(a){
  a=a.toUpperCase();
  if(a.includes("AN-24")) return "AN-24";
  if(a.includes("DHC-6")) return "DHC-6";
  if(a.includes("MI")) return "MI";
  return "";
}

fetch("chukotavia_api_results.csv")
.then(r=>r.text())
.then(csv=>{
  const l=csv.trim().split("\n");
  const h=l.shift().split(",");
  flights=l.map(r=>{
    const v=r.split(",");
    let o={};
    h.forEach((k,i)=>o[k]=v[i]);
    o.aircraftType=normalizeAircraft(o.aircraft);
    o.dateISO=o.date.split(".").reverse().join("-");
    o.priceNum=+o.price;
    return o;
  });
  initMap();
  updateSelectors();
  render();
});

function getFiltered(){
  return flights.filter(f=>
    (!from.value||f.origin===from.value)&&
    (!to.value||f.destination===to.value)&&
    (!activeAircraftType||f.aircraftType===activeAircraftType)&&
    (!dateFrom.value||f.dateISO>=dateFrom.value)&&
    (!dateTo.value||f.dateISO<=dateTo.value)
  );
}

function render(){
  let res=getFiltered();
  res.sort((a,b)=> sortMode==="price"
    ? a.priceNum-b.priceNum
    : a.dateISO.localeCompare(b.dateISO)
  );

  rows.innerHTML="";
  table.style.display=res.length?"table":"none";

  res.forEach(f=>{
    rows.innerHTML+=`
    <tr>
      <td>${f.date}</td>
      <td>${f.origin}</td>
      <td>${f.destination}</td>
      <td>${f.flight_number}</td>
      <td>${f.departure}</td>
      <td>${f.arrival}</td>
      <td>${f.aircraft}</td>
      <td>
        <a href="https://booking.chukotavia.com/websky/" target="_blank">
          <button class="buy">–æ—Ç ${f.priceNum.toLocaleString()} ‚ÇΩ</button>
        </a>
      </td>
    </tr>`;
  });

  drawRoutes(res);
}

function updateSelectors(){
  fill(from, flights.map(f=>f.origin), "–û—Ç–∫—É–¥–∞");
  fill(to, flights.map(f=>f.destination), "–ö—É–¥–∞");
}
function fill(sel,arr,label){
  const cur=sel.value;
  sel.innerHTML=`<option value="">${label}</option>`;
  [...new Set(arr)].sort().forEach(v=>sel.add(new Option(v,v)));
  sel.value=cur;
}

function setSort(m){ sortMode=m; render(); }

function resetAll(){
  from.value=to.value=dateFrom.value=dateTo.value="";
  activeAircraftType="";
  document.querySelectorAll(".aircraft-card").forEach(c=>c.classList.remove("active"));
  document.querySelector('[data-type=""]').classList.add("active");
  render();
}

/* ===== –ö–ê–†–¢–ê ===== */
let map,layer;
function initMap(){
  map=L.map("map").setView([65,170],4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  layer=L.layerGroup().addTo(map);
}
function drawRoutes(list){
  layer.clearLayers();
  list.forEach(f=>{
    if(!AIRPORTS[f.origin]||!AIRPORTS[f.destination]) return;
    let [a1,l1]=AIRPORTS[f.origin];
    let [a2,l2]=AIRPORTS[f.destination];
    if(Math.abs(l1-l2)>180){ l1>l2?l1-=360:l2-=360; }
    L.polyline([[a1,l1],[a2,l2]],{
      color:COLORS[f.aircraftType],
      weight:2,
      opacity:.85
    }).addTo(layer);
  });
}

/* ===== –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –§–ò–õ–¨–¢–†–û–í ===== */
[from,to,dateFrom,dateTo].forEach(el=>{
  el.addEventListener("change",render);
});

/* ===== –í–ò–¢–†–ò–ù–ê ===== */
document.querySelectorAll(".aircraft-card").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".aircraft-card").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    activeAircraftType=c.dataset.type;
    render();
  };
});

/* ===== DOM ===== */
const from=document.getElementById("from");
const to=document.getElementById("to");
const dateFrom=document.getElementById("dateFrom");
const dateTo=document.getElementById("dateTo");
const rows=document.getElementById("rows");
const table=document.getElementById("table");
</script>

</body>
</html>
