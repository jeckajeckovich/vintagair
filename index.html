<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>VintageAir — рейсы ЧукотАВИА</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px }
header { display:flex; align-items:center; gap:12px; margin-bottom:15px }
header img { height:42px }

.filters {
  background:#fff;
  padding:14px;
  border-radius:8px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  box-shadow:0 2px 6px rgba(0,0,0,.1)
}

select,input,button { padding:6px; font-size:14px }
button { cursor:pointer }

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:18px;
}
th,td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th { background:#eee; cursor:pointer }

.buy {
  background:#1e88e5;
  color:#fff;
  border:none;
  padding:5px 10px;
  border-radius:4px;
}

#map { height:420px; margin-top:25px; border-radius:8px }

.legend {
  margin-top:10px;
  background:#fff;
  padding:10px;
  border-radius:6px;
  display:inline-block;
}
.legend span {
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-right:12px;
}
.legend i {
  width:14px;
  height:4px;
  display:inline-block;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="VintageAir">
  <h2>✈️ VintageAir — рейсы ЧукотАВИА</h2>
</header>

<div class="filters">
  <select id="from"></select>
  <select id="to"></select>
  <select id="aircraft"></select>
  <input type="date" id="dateFrom">
  <input type="date" id="dateTo">
  <button onclick="resetFilters()">Сброс</button>
</div>

<table id="table" style="display:none">
<thead>
<tr>
  <th data-sort="date">Дата</th>
  <th>Откуда</th>
  <th>Куда</th>
  <th>Рейс</th>
  <th>Вылет</th>
  <th>Прилёт</th>
  <th>Самолёт</th>
  <th data-sort="price">Цена</th>
  <th></th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="map"></div>

<div class="legend" id="legend"></div>

<script>
/* ===== КОНСТАНТЫ ===== */

const aircraftTypes = {
  "AN-24": { color:"#d32f2f", label:"Ан-24" },
  "DHC-6": { color:"#1976d2", label:"DHC-6 Twin Otter" },
  "MI":    { color:"#388e3c", label:"Ми-8 / Ми-17" }
};

const AIRPORTS = {
  DYR:[64.734,177.741],
  PVS:[64.378,-173.242],
  KPW:[67.845,166.139],
  PWE:[69.783,170.597],
  KVM:[62.591,174.520],
  "БНГ":[63.049,179.316],
  "ВГИ":[64.405,176.002],
  "ЭГТ":[66.320,179.122],
  "ЗЛА":[64.600,176.990]
};

/* ===== СОСТОЯНИЕ ===== */

let flights=[];
let sortKey="date", sortDir=1;

/* ===== УТИЛИТЫ ===== */

const normDate = d => {
  const [dd,mm,yy]=d.split(".");
  return `${yy}-${mm}-${dd}`;
};

const aircraftKey = name => {
  name=name.toUpperCase();
  if(name.includes("AN")) return "AN-24";
  if(name.includes("DHC")) return "DHC-6";
  if(name.includes("MI")) return "MI";
  return null;
};

/* ===== ЗАГРУЗКА CSV ===== */

fetch("chukotavia_api_results.csv")
.then(r=>r.text())
.then(csv=>{
  const lines=csv.trim().split("\n");
  const h=lines.shift().split(",");
  flights=lines.map(l=>{
    const v=l.split(",");
    let o={};
    h.forEach((k,i)=>o[k]=v[i]);
    o.airKey=aircraftKey(o.aircraft);
    return o;
  });
  initMap();
  updateFilters();
  render();
  buildLegend();
});

/* ===== ФИЛЬТРЫ ===== */

function filteredFlights(){
  return flights.filter(f=>
    (!from.value || f.origin===from.value) &&
    (!to.value || f.destination===to.value) &&
    (!aircraft.value || f.airKey===aircraft.value) &&
    (!dateFrom.value || normDate(f.date)>=dateFrom.value) &&
    (!dateTo.value || normDate(f.date)<=dateTo.value)
  );
}

function updateFilters(){
  const base = filteredFlights();

  fillSelect(from, base.map(f=>f.origin), "Откуда");
  fillSelect(to, base.map(f=>f.destination), "Куда");
  fillSelect(aircraft, base.map(f=>f.airKey), "Тип ВС", true);
}

function fillSelect(sel, values, label, isAircraft=false){
  const current=sel.value;
  sel.innerHTML=`<option value="">${label}</option>`;
  [...new Set(values)].sort().forEach(v=>{
    if(!v) return;
    const text=isAircraft?aircraftTypes[v].label:v;
    sel.add(new Option(text,v));
  });
  sel.value=current;
}

function resetFilters(){
  from.value=to.value=aircraft.value="";
  dateFrom.value=dateTo.value="";
  updateFilters();
  render();
}

document.querySelectorAll("select,input").forEach(e=>{
  e.onchange=()=>{
    updateFilters();
    render();
  };
});

/* ===== РЕНДЕР ТАБЛИЦЫ ===== */

function render(){
  let res=filteredFlights();

  res.sort((a,b)=>{
    let x=a[sortKey],y=b[sortKey];
    if(sortKey!=="date"){x=+x;y=+y}
    return (x>y?1:-1)*sortDir;
  });

  rows.innerHTML="";
  table.style.display=res.length?"table":"none";

  res.forEach(f=>{
    rows.innerHTML+=`
    <tr>
      <td>${f.date}</td>
      <td>${f.origin}</td>
      <td>${f.destination}</td>
      <td>${f.flight_number}</td>
      <td>${f.departure}</td>
      <td>${f.arrival}</td>
      <td>${f.aircraft}</td>
      <td>${Number(f.price).toLocaleString()} ₽</td>
      <td>
        <a href="https://booking.chukotavia.com/websky/" target="_blank">
          <button class="buy">от ${Number(f.price).toLocaleString()} ₽</button>
        </a>
      </td>
    </tr>`;
  });

  drawMap(res);
}

/* ===== СОРТИРОВКА ===== */

document.querySelectorAll("th[data-sort]").forEach(th=>{
  th.onclick=()=>{
    const k=th.dataset.sort;
    sortDir=(sortKey===k)?-sortDir:1;
    sortKey=k;
    render();
  };
});

/* ===== КАРТА ===== */

let map, routeLayer;

function fixLng([lat,lng]){
  if(lng>180) lng-=360;
  if(lng<-180) lng+=360;
  return [lat,lng];
}

function initMap(){
  map=L.map("map",{worldCopyJump:false})
    .setView([65,170],4);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:true})
    .addTo(map);

  routeLayer=L.layerGroup().addTo(map);
}

function drawMap(list){
  routeLayer.clearLayers();
  let bounds=[];

  list.forEach(f=>{
    if(!AIRPORTS[f.origin]||!AIRPORTS[f.destination]) return;

    const a=fixLng(AIRPORTS[f.origin]);
    const b=fixLng(AIRPORTS[f.destination]);

    L.polyline([a,b],{
      color: aircraftTypes[f.airKey].color,
      weight:2,
      opacity:.85
    }).addTo(routeLayer);

    bounds.push(a,b);
  });

  if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
}

/* ===== ЛЕГЕНДА ===== */

function buildLegend(){
  const l=document.getElementById("legend");
  Object.entries(aircraftTypes).forEach(([k,v])=>{
    l.innerHTML+=`
      <span><i style="background:${v.color}"></i>${v.label}</span>
    `;
  });
}

/* ===== DOM ===== */

const from=document.getElementById("from");
const to=document.getElementById("to");
const aircraft=document.getElementById("aircraft");
const dateFrom=document.getElementById("dateFrom");
const dateTo=document.getElementById("dateTo");
const rows=document.getElementById("rows");
const table=document.getElementById("table");
</script>

</body>
</html>
